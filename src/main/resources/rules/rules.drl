package rules;

import com.example.drools.Patient;

// Правила диагностики ОКС с учетом ЧСС и АД

// Правило: Критическое состояние - Нестабильные витальные параметры
// Срабатывает при низком АД или высокой ЧСС, указывая на потенциальный шок или тяжелую аритмию.
// Должно иметь наивысший приоритет, чтобы немедленно идентифицировать критическое состояние.
rule "Критическое состояние - Нестабильные витальные"
    salience 20 // Высочайший приоритет
    when
        // Проверяем, что установлено систолическое АД ИЛИ ЧСС
        // И (систолическое АД < 90.0 ИЛИ частота сердечных сокращений > 110.0)
        // И диагноз еще не установлен (чтобы это правило имело возможность сработать первым)
        $p : Patient( (systolicBPSet == true && systolicBP < 90.0) || (heartRateSet == true && heartRate > 110.0), // Используем double для сравнения с double полями
                       diagnosis == null )
    then
        System.out.println("Правило сработало: Критическое состояние с признаками нестабильности (АД < 90 или ЧСС > 110).");
        // Устанавливаем специфичный диагноз для критического состояния
        modify($p) { setDiagnosis("Критическое состояние (шок/аритмия)") };
end

// Правило: Высокий риск ОКС - Классические признаки (при отсутствии критического состояния)
// Срабатывает, если есть классическая триада, НО нет признаков критического состояния.
rule "Высокий риск ОКС - Классические признаки"
    salience 15 // Приоритет выше, чем "Низкий риск", но ниже "Критического состояния"
    when
        // Проверяем, что данные установлены и соответствуют условиям высокого риска
        // И диагноз еще НЕ установлен правилом с более высоким приоритетом
        $p : Patient( chestPainSet == true, chestPain == true,
                      ecgAbnormalSet == true, ecgAbnormal == true,
                      troponinHighSet == true, troponinHigh == true,
                      diagnosis == null )
    then
        System.out.println("Правило сработало: Высокий риск ОКС.");
        // Устанавливаем окончательный диагноз
        modify($p) { setDiagnosis("Высокий риск ОКС") };
end

// Правило: Низкий риск ОКС - Классические признаки (при отсутствии критического состояния)
// Срабатывает, если есть боль, но нет других признаков ОКС высокого риска, НО нет признаков критического состояния.
// Также можно добавить проверку на "стабильные" витальные параметры, если они установлены.
rule "Низкий риск ОКС - Классические признаки"
    salience 10 // Приоритет ниже, чем "Высокий риск", но выше "Неопределённого риска"
    when
        // Проверяем, что данные установлены и соответствуют условиям низкого риска
        // И диагноз еще НЕ установлен более высокоприоритетными правилами
        // ИЛИ витальные параметры не установлены, ИЛИ АД >= 90 И ЧСС <= 110
        $p : Patient( chestPainSet == true, chestPain == true,
                      ecgAbnormalSet == true, ecgAbnormal == false,
                      troponinHighSet == true, troponinHigh == false,
                      (systolicBPSet == false || systolicBP >= 90.0),  // АД не установлено ИЛИ АД >= 90
                      (heartRateSet == false || heartRate <= 110.0),   // ЧСС не установлено ИЛИ ЧСС <= 110
                      diagnosis == null )
    then
        System.out.println("Правило сработало: Низкий риск ОКС.");
        // Устанавливаем окончательный диагноз
        modify($p) { setDiagnosis("Низкий риск ОКС") };
end

// Правило: Подозрение на ОКС - Неполные данные (при отсутствии критического состояния)
// Срабатывает, если есть боль в груди, но недостаточно данных для классификации риска ОКС (ЭКГ или тропонин не установлены/нормальные),
// и при этом нет признаков критического состояния.
rule "Подозрение на ОКС - Неполные данные"
    salience 5 // Приоритет ниже, чем Низкий риск
    when
        // Проверяем, что боль в груди установлена и положительна
        // И не установлены все основные данные (ЭКГ ИЛИ тропонин не установлены)
        // И диагноз еще НЕ установлен более высокоприоритетными правилами
        // ИЛИ витальные параметры не установлены, ИЛИ АД >= 90 И ЧСС <= 110 (т.е. нет критического состояния)
         $p : Patient( chestPainSet == true, chestPain == true,
                       (ecgAbnormalSet == false || troponinHighSet == false), // Неполные данные для полной классификации риска ОКС
                       (systolicBPSet == false || systolicBP >= 90.0),  // АД не установлено ИЛИ АД >= 90
                       (heartRateSet == false || heartRate <= 110.0),   // ЧСС не установлено ИЛИ ЧСС <= 110
                       diagnosis == null )
    then
        System.out.println("Правило сработало: Подозрение на ОКС при неполных данных.");
        modify($p) { setDiagnosis("Подозрение на ОКС, требуются ЭКГ и тропонин") };
end

// Правило: Неопределённый диагноз
// Срабатывает, если ни одно из предыдущих правил не установило диагноз (например, нет даже боли в груди, или данные неполные и не соответствуют другим правилам).
rule "Неопределённый диагноз"
    salience -10 // Самый низкий приоритет, срабатывает последним
    when
        // Проверяем, что поле diagnosis до сих пор равно null
        $p : Patient( diagnosis == null )
    then
        System.out.println("Правило сработало: Не удалось определить диагноз.");
        // Устанавливаем диагноз по умолчанию
        modify($p) { setDiagnosis("Не удалось определить диагноз") };
end